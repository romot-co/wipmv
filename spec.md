# オーディオビジュアライザー生成アプリケーション設計書

1. 概要
このアプリケーションは、ユーザーがオーディオファイルをアップロードし、そのオーディオデータに基づいてビジュアルエフェクトを適用した動画を生成するウェブアプリケーションです。生成された動画はプレビューとダウンロードが可能です。

2. アーキテクチャ
このアプリケーションは、以下のコンポーネントで構成されています。

2.1 UIコンポーネント
- FileUploader: オーディオファイルのアップロードUIを提供します。
- EffectSelector: 適用するビジュアルエフェクトの選択UIを提供します。
- PreviewPlayer: 生成された動画のプレビューUIを提供します。
- BackgroundSelector: 背景画像のアップロードまたは背景色の選択UIを提供します。

2.2 ロジックコンポーネント
- AudioAnalyzer: アップロードされたオーディオファイルを解析し、以下のデータを抽出します。
  - 時間データ (timeData)
  - 振幅データ (amplitudeData)
  - 音量データ (volumeData)
  - 周波数データ (frequencyData)
  - 位相データ (phaseData)
  - ステレオデータ (stereoData)
  - ダイナミックレンジデータ (dynamicRangeData)
  - スペクトル重心データ (spectralCentroidData)
  - スペクトルフラックスデータ (spectralFluxData)

- VisualEffect: ビジュアルエフェクトの基底クラスです。
- VisualEffectNode: ビジュアルエフェクトの構成要素となる単一の効果を適用します。
  - FrequencyDataNode: 周波数データを正規化します。
  - AmplitudeDataNode: 振幅データを正規化します。
  - VolumeDataNode: 音量データを正規化します。
  - PhaseDataNode: 位相データを正規化します。
  - StereoDataNode: ステレオバランスデータを正規化します。
  - ColorCyclerNode: 色を周期的に変化させます。
  - OpacityNode: 不透明度を設定します。
  - WaveformNode: 波形を表示します。
  - RadialBarDrawerNode: 放射状のバーを描画します。
  - BarDrawerNode: 周波数バーを描画します。
  - RippleNode: 波紋エフェクトを描画します。
  - MeteorNode: 流星エフェクトを描画します。
  - WatermarkNode: ウォーターマークを表示します。
  - BackgroundNode: 背景画像または背景色を描画します。
  - GradientBackgroundNode: グラデーション背景を描画します。

- VisualEffectManager: VisualEffectを管理し、パラメータに基づいてエフェクトを適用します。
- CanvasRenderer: ビジュアルエフェクトをキャンバスにレンダリングします。
- VideoEncoderService: キャンバスのフレームをMP4ビデオストリームにエンコードします。
- AudioEncoderService: オーディオデータをMP4互換フォーマットにエンコードします。
- MP4Multiplexer: エンコードされたビデオとオーディオのストリームを結合します。

- 標準エフェクト:
  - BackgroundEffect: 背景画像または背景色を設定します。以下の機能を提供:
    - 単色背景
    - グラデーション背景
    - 画像背景
    - 音楽に反応する背景色の変化
    - クロスフェード遷移効果

3. データフロー
1. FileUploaderを介してユーザーがオーディオファイルをアップロードします。
2. AudioAnalyzerがオーディオファイルを解析し、各種データを抽出します。
3. ユーザーがEffectSelectorを使用して適用するエフェクトを選択します。
4. ユーザーが動画生成を開始します。
5. CanvasRendererが各フレームをレンダリングします。
6. VideoEncoderServiceがフレームをエンコードします。
7. AudioEncoderServiceがオーディオデータをエンコードします。
8. MP4Multiplexerがエンコードされたストリームを結合します。
9. 生成された動画がプレビュー表示され、ダウンロード可能になります。

4. エンコード設定
- ビデオ設定:
  - コーデック: H.264 High Profile (avc1.64001F)
  - ビットレート: 2Mbps
  - フレームレート: 30fps
  - 解像度: 960x600

- オーディオ設定:
  - コーデック: AAC-LC (mp4a.40.2)
  - ビットレート: 192kbps
  - サンプルレート: 入力ファイルに依存
  - チャンネル数: 入力ファイルに依存

5. 非機能要件
- ブラウザ: 最新版のGoogle Chromeをサポートします。
- パフォーマンス: 動画生成中もUIはレスポンシブである必要があります。
- ユーザーエクスペリエンス: 
  - 進捗状況の表示
  - エラーメッセージの明確な表示
  - エフェクトの有効/無効を簡単に切り替え可能
- ファイルサイズ制限: パフォーマンスの問題を防ぐため、アップロードファイルのサイズを制限します。

6. 今後の拡張性
- 新しいビジュアルエフェクトの追加
- エフェクトのパラメータ調整UI
- 動画の解像度やビットレートの選択オプション
- リアルタイムプレビュー機能
- エフェクトの順序変更機能
- カスタムエフェクトの作成機能 

## エンコード設定

### 概要
動画のエンコード設定をカスタマイズ可能にし、ユーザーのニーズに合わせた出力品質を実現します。

### プリセット
以下の3つのプリセットを提供します：

1. 高品質プリセット
   - ビデオ：8Mbps, H.264, 高品質設定
   - オーディオ：320kbps, AAC
   - 用途：高品質な動画が必要な場合

2. バランス型プリセット（デフォルト）
   - ビデオ：4Mbps, H.264, 標準品質設定
   - オーディオ：192kbps, AAC
   - 用途：一般的な用途

3. 軽量プリセット
   - ビデオ：2Mbps, H.264, 高速設定
   - オーディオ：128kbps, AAC
   - 用途：ファイルサイズを抑えたい場合

### カスタマイズ可能な設定

#### ビデオ設定
- 解像度（幅×高さ）
- フレームレート（fps）
- コーデック（H.264, H.265, VP8, VP9）
- ビットレート
- キーフレーム間隔
- エンコード品質（0-1）
- エンコードプリセット（fast/balanced/quality）

#### オーディオ設定
- サンプリングレート（44.1kHz, 48kHz, 96kHz）
- チャンネル数（モノラル/ステレオ）
- コーデック（AAC, Opus, Vorbis）
- ビットレート
- 品質設定（0-1）

#### 出力設定
- コンテナフォーマット（MP4, WebM, MKV）
- メタデータ
  - タイトル
  - アーティスト
  - 日付
  - コメント

### 設定の永続化
- IndexedDBを使用して設定を保存
- アプリケーション再起動時に設定を復元
- プリセットと個別設定の両方に対応

### UI/UX
- 直感的な設定インターフェース
- プリセット選択による簡単設定
- 詳細設定の展開/折りたたみ
- リアルタイムプレビュー
- レスポンシブデザイン対応

### エラーハンドリング
- コーデックサポートチェック
- 無効な設定値の検証
- エラーメッセージの表示
- フォールバック設定の提供 